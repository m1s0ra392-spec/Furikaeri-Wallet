{% extends "base.html" %}

{% block content %}

<h2 style="margin:16px 0 8px;">トピック投稿</h2>

<form method="post" novalidate>
  {% csrf_token %}

  {# --- カテゴリ --- #}
  <div style="margin:12px 0;">
    <div style="font-size:13px; color:#555; margin-bottom:6px;">カテゴリ</div>

    {# board_category が RadioSelect なら横並びにしやすい #}
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      {{ form.board_category }}
    </div>

    {% if form.board_category.errors %}
      <div style="color:#c00; font-size:12px; margin-top:6px;">
        {{ form.board_category.errors }}
      </div>
    {% endif %}
  </div>

  {# --- タイトル --- #}
  <div style="margin:12px 0;">
    <div style="font-size:13px; color:#555; margin-bottom:6px;">タイトル</div>
    {{ form.title }}
    {% if form.title.errors %}
      <div style="color:#c00; font-size:12px; margin-top:6px;">
        {{ form.title.errors }}
      </div>
    {% endif %}
  </div>

  {# --- 本文（1000字） --- #}
  <div style="margin:12px 0;">
    <div style="font-size:13px; color:#555; margin-bottom:6px;">内容を書く</div>
    {{ form.text }}

    <div style="font-size:12px; color:#888; margin-top:6px;">
      ※1000文字以内で入力してください
    </div>

    {% if form.text.errors %}
      <div style="color:#c00; font-size:12px; margin-top:6px;">
        {{ form.text.errors }}
      </div>
    {% endif %}
  </div>

 <!-- タグ選択（投稿画面側） -->
<div style="margin-top:12px;">
  <button type="button" id="open-tag-modal"
          style="padding:8px 12px; border:1px solid #bbb; border-radius:6px; background:#eee; cursor:pointer;">
    タグを追加（任意）
  </button>

  <!-- 選択済みタグがここに表示される -->
  <div id="selected-tags-on-form" style="display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;"></div>

  <!-- 送信用：選択したタグidをカンマで詰める -->
  <input type="hidden" name="selected_tag_ids" id="selected-tag-ids" value="">
</div>



  {# --- status は表示しない（ボタンで決める） --- #}
  {{ form.status.as_hidden }}

  {# --- ボタン（actionで分岐させる前提） --- #}
  <div style="display:flex; gap:10px; margin-top:18px;">
    <button type="submit"
            name="action" value="confirm"
            style="flex:1; padding:12px; border:none; border-radius:6px; background:#2f6f5e; color:#fff; font-weight:bold;">
      トピックを投稿する
    </button>

    <button type="submit"
            name="action" value="draft"
            style="flex:1; padding:12px; border:2px solid #2f6f5e; border-radius:6px; background:#fff; color:#2f6f5e; font-weight:bold;">
      下書き保存
    </button>
  </div>

</form>


<!-- タグモーダル -->
<div id="tag-modal-overlay"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999;">
  <div id="tag-modal"
       style="width:min(92vw, 420px); margin:60px auto; background:#fff; border-radius:10px; overflow:hidden;">

    <!-- ヘッダー -->
    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid #eee;">
      <div style="font-weight:bold;">#タグ一覧</div>
      <button type="button" id="close-tag-modal"
              style="border:none; background:transparent; font-size:18px; cursor:pointer;">×</button>
    </div>

    <div style="padding:14px;">
      <!-- 新規タグ（枠だけ：今日はまだ作成APIがないので押しても何もしない） -->
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
        <input id="new-tag-input" type="text" placeholder="新規タグ"
               style="flex:1; padding:8px; border:1px solid #ccc; border-radius:6px;">
        <button type="button" id="new-tag-add"
                style="width:44px; padding:8px 0; border:1px solid #ccc; border-radius:6px; background:#f3f3f3;">
          ＋
        </button>
      </div>

      <!-- 検索（既存タグ候補を出す） -->
      <input id="tag-search-input" type="text" placeholder="タグを検索（例：節）"
             autocomplete="off"
             style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px;">

      <!-- 候補（検索結果） -->
      <div id="tag-suggestions"
           style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      </div>

      <!-- 選択済み（モーダル内でも見えるように） -->
      <div style="margin-top:12px; font-size:12px; color:#666;">選択中</div>
      <div id="selected-tags-in-modal" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;"></div>

      <!-- 決定ボタン -->
      <button type="button" id="apply-tags"
              style="width:100%; margin-top:14px; padding:10px; border:1px solid #bbb; border-radius:8px; background:#eee; cursor:pointer;">
        トピック内容に入力
      </button>
    </div>
  </div>
</div>


<style>
  input[type="text"], textarea, select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
  }
  textarea { min-height: 180px; }

  /* RadioSelectがul/liになることが多いので整える */
  ul { list-style: none; padding-left: 0; margin: 0; display:flex; gap:12px; flex-wrap:wrap; }
  li { margin: 0; }
  label { cursor: pointer; }
</style>


<!--タグモーダル用JS-->
<script>
(() => {
  const overlay = document.getElementById("tag-modal-overlay");
  const openBtn = document.getElementById("open-tag-modal");
  const closeBtn = document.getElementById("close-tag-modal");
  const applyBtn = document.getElementById("apply-tags");

  const searchInput = document.getElementById("tag-search-input");
  const suggestions = document.getElementById("tag-suggestions");

  const selectedOnForm = document.getElementById("selected-tags-on-form");
  const selectedInModal = document.getElementById("selected-tags-in-modal");
  const hidden = document.getElementById("selected-tag-ids");

  // 今日は「既存タグを選ぶ」まで。選択状態はここで管理
  const selected = new Map(); // id -> name

  let timer = null;

  function openModal() {
    overlay.style.display = "block";
    searchInput.value = "";
    suggestions.innerHTML = "";
    renderSelectedInModal();
    setTimeout(() => searchInput.focus(), 0);
  }

  function closeModal() {
    overlay.style.display = "none";
  }

  function renderHidden() {
    hidden.value = Array.from(selected.keys()).join(",");
  }

  function makeChip({ id, name, removable = false }) {
    const chip = document.createElement("button");
    chip.type = "button";
    chip.textContent = removable ? `${name} ×` : `#${name}`;
    chip.style.cssText = `
      padding:6px 10px; border:1px solid #ccc; border-radius:999px;
      background:#fff; cursor:pointer; font-size:12px;
    `;
    chip.dataset.id = id;
    return chip;
  }

  function renderSelectedOnForm() {
    selectedOnForm.innerHTML = "";
    for (const [id, name] of selected.entries()) {
      const chip = makeChip({ id, name, removable: true });
      chip.addEventListener("click", () => {
        selected.delete(Number(id));
        renderSelectedOnForm();
        renderSelectedInModal();
        renderHidden();
      });
      selectedOnForm.appendChild(chip);
    }
  }

  function renderSelectedInModal() {
    selectedInModal.innerHTML = "";
    for (const [id, name] of selected.entries()) {
      const chip = makeChip({ id, name, removable: true });
      chip.addEventListener("click", () => {
        selected.delete(Number(id));
        renderSelectedInModal();
        renderSelectedOnForm();
        renderHidden();
      });
      selectedInModal.appendChild(chip);
    }
  }

  function renderSuggestions(items) {
    suggestions.innerHTML = "";
    items.forEach(item => {
      const chip = makeChip({ id: item.id, name: item.name, removable: false });

      // 選択状態に応じて見た目を変える（画像の「選択すると色が変わる」イメージ）
      if (selected.has(item.id)) {
        chip.style.background = "#e8f4ea";
        chip.style.borderColor = "#8bbf95";
      }

      chip.addEventListener("click", () => {
        if (selected.has(item.id)) {
          selected.delete(item.id);
        } else {
          selected.set(item.id, item.name);
        }
        renderSuggestions(items);     // 色反映
        renderSelectedInModal();
        renderSelectedOnForm();
        renderHidden();
      });

      suggestions.appendChild(chip);
    });
  }

  async function fetchTags(q) {
    const url = `/board/api/tags/?q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" }});
    if (!res.ok) return [];
    return await res.json();
  }

  openBtn.addEventListener("click", openModal);
  closeBtn.addEventListener("click", closeModal);

  // overlayクリックで閉じる（中身クリックは無視）
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) closeModal();
  });

  applyBtn.addEventListener("click", () => {
    // 仕様：「トピック内容に入力」ボタンで閉じる＆投稿画面に反映（すでに反映されてるけど、閉じる役）
    closeModal();
  });

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.trim();
    clearTimeout(timer);

    if (!q) {
      suggestions.innerHTML = "";
      return;
    }

    timer = setTimeout(async () => {
      const items = await fetchTags(q);
      renderSuggestions(items);
    }, 200);
  });

  // 「新規タグ＋」は今日は枠だけ（押しても何もしない）
  document.getElementById("new-tag-add").addEventListener("click", () => {
    alert("新規タグ作成は次のステップ（作成API）で実装します。今日は既存タグの選択まで！");
  });
})();
</script>

{% endblock %}